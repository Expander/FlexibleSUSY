#!/bin/sh

# configure script for FlexibleSUSY
# Author: Alexander Voigt

PROGRAM_NAME=FlexibleSUSY
FLEXIBLESUSY_MAJOR=0
FLEXIBLESUSY_MINOR=5
FLEXIBLESUSY_PATCH=3
FLEXIBLESUSY_EXTRA=
FLEXIBLESUSY_VERSION="${FLEXIBLESUSY_MAJOR}.${FLEXIBLESUSY_MINOR}.${FLEXIBLESUSY_PATCH}${FLEXIBLESUSY_EXTRA}"

# directory of this script
BASEDIR=$(dirname $0)

# absolute path to this script
ABSBASEDIR=$(cd $BASEDIR; pwd)

# config directory
CONFIGDIR="${BASEDIR}/config"

# current date
DATE="`(date --rfc-2822) 2>/dev/null || echo unknown`"

# platform information
debmultiarch=""

# default library directories
default_lib_paths="/usr/lib /usr/local/lib"
default_inc_paths="/usr/include /usr/local/include"

# configure log file
logfile="$BASEDIR/config.log"
statusfile="$BASEDIR/config.status"
sarahconfig="$BASEDIR/config.sarah"
boostconfig="$BASEDIR/config.boost"
gppconfig="$BASEDIR/config.g++"
mathconfig="$BASEDIR/config.math"

# whether we are in 32-bit or 64-bit environment
machine_word_size="unknown"

# operating system
operating_system="unknown"

# kernel version (uname -r)
kernel_version="unknown"

# target makefile
MAKEFILE=$BASEDIR/Makefile
MAKEFILE_TMPL=${CONFIGDIR}/Makefile.in

# target config script
FSCONFIG=$BASEDIR/flexiblesusy-config
FSCONFIG_TMPL=${CONFIGDIR}/flexiblesusy-config.in

# target sarah dependency generation script
SARAH_DEP_GEN=${CONFIGDIR}/list_sarah_model_files.sh
SARAH_DEP_GEN_TMPL=${CONFIGDIR}/list_sarah_model_files.sh.in

# target config header
CONFIGHDR=${CONFIGDIR}/config.h
CONFIGHDR_TMPL=${CONFIGDIR}/config.h.in

# target tex file with package version
TEXVERSION=$BASEDIR/doc/version.tex
TEXVERSION_TMPL=$BASEDIR/doc/version.tex.in

# target dox file with Doxygen \mainpage
DOC_MAINPAGE=$BASEDIR/doc/mainpage.dox
DOC_MAINPAGE_TMPL=$BASEDIR/doc/mainpage.dox.in

# target makefile file for the standalone example
STANDALONE_MAKEFILES="\
 ${BASEDIR}/examples/standalone-model/Makefile \
 ${BASEDIR}/examples/standalone-rge/Makefile"
STANDALONE_MAKEFILE_TMPL="${BASEDIR}/config/Makefile.standalone.in"

# target makefile file for the tower example
TOWER_MAKEFILES="
 ${BASEDIR}/examples/tower/Makefile"
TOWER_MAKEFILE_TMPL="${BASEDIR}/config/Makefile.tower.in"

# options
deprecated_options=""
options="                    \
   enable_colors             \
   enable_compile            \
   enable_compiler_warnings  \
   enable_debug              \
   enable_fflite             \
   enable_looptools          \
   enable_silent             \
   enable_static_libs        \
   enable_threads            \
   enable_verbose            \
"

# BEGIN: NOT EXPORTED ##########################################
options="${options}          \
   enable_meta               \
"
# END:   NOT EXPORTED ##########################################

enable_compile="yes"
enable_compiler_warnings="no"
enable_colors="no"
enable_debug=""
enable_fflite="no"
enable_looptools="no"
enable_meta="no"
# BEGIN: NOT EXPORTED ##########################################
enable_meta="yes"
# END:   NOT EXPORTED ##########################################
enable_silent="no"
enable_static_libs="yes"
enable_threads="yes"
enable_verbose="no"

# corresponding preprocessor define statements
DEFINE_ENABLE_COLOR_PRINTOUT="#undef ENABLE_COLOR_PRINTOUT"
DEFINE_ENABLE_DEBUG="#undef ENABLE_DEBUG"
DEFINE_ENABLE_FFLITE="#undef ENABLE_FFLITE"
DEFINE_ENABLE_LOOPTOOLS="#undef ENABLE_LOOPTOOLS"
DEFINE_ENABLE_RANDOM="#undef ENABLE_RANDOM"
DEFINE_ENABLE_SILENT="#undef ENABLE_SILENT"
DEFINE_ENABLE_THREADS="#define ENABLE_THREADS 1"
DEFINE_ENABLE_VERBOSE="#undef ENABLE_VERBOSE"

boost_lib_dir=""
boost_inc_dir=""
eigen_inc_dir=""
BOOSTFLAGS=""
gsl_config="gsl-config"
lapack_lib_dir=""
looptools_lib_dir=""
looptools_inc_dir=""
GSLFLAGS=""
CPPFLAGS=""
CXXFLAGS="-std=c++11 -O2"
CXXFLAGS_DEP_GEN="-std=c++11"
FFLAGS="-O2"
FLIBS=""
BOOSTTESTLIBS=""
BOOSTTHREADLIBS=""
THREADLIBS=""
LIBEXT=".a"
CXX="g++"
CXX_DEP_GEN="${CXX}"
EIGENFLAGS=""
FC="gfortran"
FOR_DEP_GEN="${FC}"
GSLLIBS=""
INSTALL_DIR=""
LAPACKLIBS=""
MAKELIB="ar cru"
MATH="math"
# available RG algorithms
ALGORITHMS="two_scale"
available_algorithms="two_scale lattice"
# models that will be compiled
MODELS="all"

# C++ compiler type and version
cxx_compiler_type="unknown"
cxx_compiler_version="unknown"

# required C++ compiler versions
required_cxx_compiler_version="unknown"
required_gpp_compiler_version="4.4.7"
required_clang_compiler_version="3.1.0"
required_icpc_compiler_version="12.1.0"

# C++ dependency generator type and version
cxx_dep_gen_type="unknown"
cxx_dep_gen_version="unknown"

# required C++ dependency generator versions
# to be added

# C++ compiler and dependency generator versions accepting `-std=c++11'
std_cxx11_compiler_version="unknown"
std_cxx11_dep_gen_version="unknown"
std_cxx11_gpp_version="4.7.0"
std_cxx11_clang_version="3.0.0"
std_cxx11_icpc_version="13.0.0"

# required boost version
required_boost_version="1.49.0"

# required Mathematica version
required_mathematica_version="7"

# required SARAH version
required_sarah_major="4"
required_sarah_minor="0"
required_sarah_patch="4"
required_sarah_version="${required_sarah_major}.${required_sarah_minor}.${required_sarah_patch}"
SARAH_VERSION="unknown"
SARAH_MAJOR="0"
SARAH_MINOR="0"
SARAH_PATCH="0"

# Mathematica version (0 = unknown)
MATH_VERSION="0"

# string to eval when script terminates, normally or not
actions_at_exit=""

#_____________________________________________________________________
at_exit() {
    local action
    for action in "$@"; do
	printf "%s\n" "$actions_at_exit" | grep -F -e "$action" > /dev/null ||
	actions_at_exit="$actions_at_exit
$action"
    done
}

#_____________________________________________________________________
do_actions_at_exit() {
    logmsg "Executing clean-up actions:$actions_at_exit"
    eval "$actions_at_exit"
}

#_____________________________________________________________________
write_configure_parameters() {
    # This function writes all parameters [$*] to config.status
    configargs="$*"
    configargs=`echo $configargs | sed 's,\\\,\\\\,g'`
    echo "$configargs" > $statusfile
}

#_____________________________________________________________________
message() {
    # Write a simple message to std out (and to the log file)
    if test $# -lt 1 ; then
        echo "message: Too few arguments"
        return 1
    fi
    echo "$*"
    logmsg "$*"
}

#_____________________________________________________________________
logmsg() {
    # Write message to the log file.  Use -n as first parameter to
    # prevent a newline at the end of the message.
    if test $# -lt 1 ; then
        echo "logmsg: Too few arguments"
        return 1
    fi
    if test "x$1" = "x-n"; then
       shift
       printf "%s" "$*" >> $logfile
    else
       echo "$*" >> $logfile
    fi
}

#_____________________________________________________________________
log_package_information() {
    logmsg "Package: ${PROGRAM_NAME}"
    logmsg "Version: ${FLEXIBLESUSY_VERSION}"
    logmsg "Date:    ${DATE}"
}

#_____________________________________________________________________
guess_machine_word_size() {
    chip=`uname -m | tr '[A-Z]' '[a-z]'`
    case "$chip" in
        *32) machine_word_size="32"; return 0 ;;
        *64) machine_word_size="64"; return 0 ;;
        *)   machine_word_size="unknown"
             message "Warning: could not guess machine word size"
             return 1 ;;
    esac
}

#_____________________________________________________________________
contains() {
    # Check if string $1 contains $2
    if test $# -lt 2 ; then
        echo "contains: Too few arguments"
        return 1
    fi
    string="$1"
    substring="$2"
    for f in ${string}; do
        if test "x$f" = "x$substring" ; then
            return 0 # found
        fi
    done
    return 1 # not found
}

#_____________________________________________________________________
contains_not() {
    # Check if string $1 does not contain $2
    if test $# -lt 2 ; then
        echo "contains: Too few arguments"
        return 1
    fi
    contains "$1" "$2"
    if [ $? -eq 0 ]; then
        return 1
    else
        return 0
    fi
}

#_____________________________________________________________________
check_library() {
    # This function will try to locate a library [$1] in the directory
    # given in $2 or in a default path [$*].
    #
    # The result of the search is stored in found_lib and found_dir,
    # which should be immediately copied, since the variables value will
    # be overwritten at next invocation of this function.

    # Assert that we got enough arguments
    if test $# -lt 3 ; then
        echo "check_library: Too few arguments"
        return 1
    fi

    # Save arguments in local names
    lib=$1       ; shift
    libdirl=$1
    libdirs="$*"
    # check if we got a specific argument as to where the library
    # is to be found
    if test ! "x$libdirl" = "x" ; then
        libdirs=$libdirl
    fi

    # Write a message
    checking_msg "$lib"

    libs=""
    for i in $lib ; do
        for ext in .a .lib "" .so .sl .dylib .dll.a ; do
            libs="$libs $i$ext"
        done
    done

    found_dir=""
    found_lib=""

    if test "x$machine_word_size" = "x64"; then
	for p in ${libdirs}; do
            libdir64=`echo "$p" | grep lib | sed -e 's|lib$|lib64|g' -e 's|lib/|lib64/|g'`
            libdirs="$libdirs $libdir64"
	done
    fi
    if test "x$machine_word_size" = "x32"; then
	for p in ${libdirs}; do
            libdir32=`echo "$p" | grep lib | sed -e 's|lib$|lib32|g' -e 's|lib/|lib32/|g'`
            libdirs="$libdirs $libdir32"
	done
    fi
    # look first in the DEB_HOST_MULTIARCH directories
    if test "x$debmultiarch" != "x" ; then
	for p in ${libdirs}; do
            multiarch_libdir=`echo "$p" | sed "s|lib$|lib/$debmultiarch|"`
            libdirs="$multiarch_libdir $libdirs"
	done
    fi

    for p in ${libdirs}; do
        for l in ${libs}; do
            liblist=`echo $p/$l` # expands wildcard
            for n in ${liblist} ; do
                if test -f $n ; then
                    found_dir=$p
                    found_lib=$l
                    break 3
                fi
            done
        done
    done

    if test "x$found_dir" = "x" || test "x$found_lib" = "x" ; then
        result "not found in $libdirs"
    else
        result "found in $found_dir"
    fi
}

#_____________________________________________________________________
check_header() {
    # This function will try to locate a header file [$1] in the
    # directory given in $2 or in a default path [$*].
    #
    # The result of the search is stored in found_hdr and found_dir,
    # which should be immediately copied, since the variables value
    # will be overwritten at next invocation of this function.

    # Assert that we got enough arguments
    if test $# -lt 2 ; then
        echo "check_header: Too few arguments"
        return 1
    fi

    # Save arguments in local names
    hdr=$1       ; shift
    hdrdirl=$1
    hdrdirs="$*"
    # check if we got a specific argument as to where the library
    # is to be found
    if test ! "x$hdrdirl" = "x" ; then
        hdrdirs=$hdrdirl
    fi

    # Write a message
    checking_msg "$hdr"

    hdrs=""
    for i in $hdr ; do
        for ext in "" .h .hpp ; do
            hdrs="$hdrs $i$ext"
        done
    done

    found_dir=""
    found_hdr=""

    for p in ${hdrdirs}; do
        for h in ${hdrs}; do
            hdrlist=`echo $p/$h` # expands wildcard
            for n in ${hdrlist} ; do
                if test -f $n ; then
                    found_dir=$p
                    found_hdr=$hdr
                    break 3
                fi
            done
        done
    done

    if test "x$found_dir" = "x" || test "x$found_hdr" = "x" ; then
        result "not found in $hdrdirs"
    else
        result "found in $found_dir"
    fi
}

#_____________________________________________________________________
checking_msg() {
    # Write a simple "checking" message to std out.
    if test $# -lt 1 ; then
        echo "checking_msg: Too few arguments"
        return 1
    fi
    printf "Checking for"
    logmsg -n "Checking for"
    while test $# -gt 1 ; do
        printf " %s," "$1"
        logmsg -n " $1,"
        shift
        if test $# -eq 1 ; then
            printf " or"
            logmsg -n " or"
        fi
    done
    printf " %s ... " "$1"
    logmsg -n " $1 ... "
}

#_____________________________________________________________________
result() {
    echo "$*"
    logmsg ""
    logmsg "   Result: $*"
}

#_____________________________________________________________________
check_symbol() {
    # This function will try to locate a symbol [$1] in a specific
    # library [$2] and in a given directory [$3].
    # The result of the check is stored in found_symbol, 1 if true,
    # 0 otherwise, which should be immediately copied, since the variable
    # will be overwritten at next invocation of this function.

    local symbol
    local symbollib
    local symboldir

    # Assert that we got enough arguments
    if test $# -ne 3 ; then
        echo "check_symbol: not 3 arguments"
        found_symbol=0
        return 1
    fi

    # Save arguments in logical names
    symbol=$1     ; shift
    symbollib=$1  ; shift
    symboldir=$1

    if test "x$symbollib" = "x" ; then
        found_symbol=0
        return 1
    fi

    symbollib=`echo $symbollib | sed -e 's/^-l/lib/'`

    if test ! "x$symboldir" = "x" ; then
        symboldir=`echo $symboldir | sed -e 's/^-L//'`
    fi

    # Check if we got a specific argument as to where the library
    # is to be found
    symbolfile=$symbollib
    exts=".so .lib .dylib"
    if test ! "x$shared" = "xno" ; then
        exts="$exts .a"
    else
        exts=".a $exts"
    fi

    usrlib="/usr/lib"
    if test "x$machine_word_size" = "x32" ; then
        usrlib="/usr/lib32 $usrlib"
    fi
    if test "x$machine_word_size" = "x64" ; then
        usrlib="/usr/lib64 $usrlib"
    fi

    for d in "$symboldir" $usrlib ; do
        logmsg " Checking in $d"
        if test ! -r $d/$symbollib ; then
            logmsg "  $d/$symbollib not readable"
            for i in $exts ; do
                logmsg "   Checking extension $i with $d/$symbollib"
                if test -r $d/$symbollib$i ; then
                    logmsg "   $d/$symbollib$i readable"
                    symbolfile=$d/$symbollib$i
                    break 2
                fi
             done
        else
            logmsg "  $d/$symbollib readable"
            symbolfile=$d/$symbollib
            break
        fi
    done

    if test "x$symbolfile" = "x" || test ! -r $symbolfile ; then
       found_symbol=0
       logmsg " Symbol not found"
       return 1
    fi

    checking_msg "$symbol in $symbolfile"
    nm $symbolfile 2>&1 | grep $symbol > /dev/null 2>&1 ||
    nm -D $symbolfile 2>&1 | grep $symbol > /dev/null 2>&1
    if test $? -eq 0 ; then
        found_symbol=1
        logmsg -n "symbol found"
    else
        nm $symbolfile 2>&1 | grep "no symbols" > /dev/null 2>&1
        # if test $? -eq 0 ; then
        #     logmsg " $symbolfile is stripped, trying to link"
        #     # stripped library - only safe test is to link against the library
        #     check_link $symbolfile "" $symbol
        #     found_symbol=$link_result
        # else
            found_symbol=0
        # fi
    fi

    if test $found_symbol -eq 1 ; then
        result "ok"
	return 0
    else
        result "no"
	return 1
    fi
}

#_____________________________________________________________________
split_version() {
    local version="$1"
    local major_var="$2"
    local minor_var="$3"
    local patch_var="$4"

    set -- $(printf "%s" "$version" |
	     sed 's/^\([[:digit:].]*\).*$/\1/' | tr . ' ')
    eval "$major_var=\"${1:-0}\""
    eval "$minor_var=\"${2:-0}\""
    eval "$patch_var=\"${3:-0}\""
}

#_____________________________________________________________________
major_minor_patch_at_least() {
    local     major=$1
    local     minor=$2
    local     patch=$3
    local min_major=$4
    local min_minor=$5
    local min_patch=$6

    if   [ $major -gt $min_major ]; then return 0
    elif [ $major -lt $min_major ]; then return 1
    elif [ $minor -gt $min_minor ]; then return 0
    elif [ $minor -lt $min_minor ]; then return 1
    elif [ $patch -ge $min_patch ]; then return 0
    else				 return 1
    fi
}

#_____________________________________________________________________
version_at_least() {
    local version="$1"
    local min_version="$2"

    local major minor patch
    split_version "$version" major minor patch

    local m_major m_minor m_patch
    split_version "$min_version" m_major m_minor m_patch

    major_minor_patch_at_least $major $minor $patch $m_major $m_minor $m_patch
}

#_____________________________________________________________________
try_compile_cpp_program() {
    # This function compiles a C++ testprogram with the header
    # inclusion given in [$1] and a statement given in [$2].

    if test $# -ne 2 ; then
        echo "try_compile_cpp_program: Two arguments required!"
        exit 1
    fi

    local _header="$1"
    local _statement="$2"

    logmsg ""
    logmsg "==================================="
    logmsg "Trying to compile test program with"
    logmsg "   Header: ${_header}"
    logmsg "   Statement: ${_statement}"

    local _suppress_separator=true

    try_compile_run_cpp_program "${_header}
int main() {
   ${_statement};
   return 0;
}"
}

#_____________________________________________________________________
try_compile_run_cpp_program() {
    # This function compiles a C++ source code given in [$1]
    # using the compiler given in [$2] or $CXX if $2 is unset
    # with compiler flags given in [$3] or $CXXFLAGS if $3 is unset.
    # It subsequently executes the resulting executable whose
    # output through stdout and stderr is stored in cpp_output
    # and whose exit code is stored in cpp_exit.

    if [ $# -lt 1 -o $# -gt 3 ]; then
        echo "try_compile_run_cpp_program: 1, 2, or 3 arguments required!"
        exit 1
    fi

    local cxx="$2"
    if [ -z "$cxx" ]; then
	if test "x${CXX}" = "x"; then
            echo "try_compile_run_cpp_program: CXX is not set!"
            exit 1
	fi
	cxx="$CXX"
    fi
    local cxxflags="$3"
    [ -z "$cxxflags" ] && cxxflags="$CXXFLAGS"
    local source_code="$1"
    local _src="${BASEDIR}/conftest.cpp"
    local _exe="${BASEDIR}/conftest.x"
    local _log="${BASEDIR}/conftest.log"

    at_exit "rm -f \"${_exe}\" \"${_src}\" \"${_log}\""

    logmsg ""
    [ "$_suppress_separator" = true ] ||
    logmsg "==================================="
    logmsg "Trying to compile test program"

    printf "%s\n" "$source_code" > ${_src}

    # compile the source
    ${cxx} -o ${_exe} ${cxxflags} ${_src} > ${_log} 2>&1 || {
        logmsg "   Status: compilation failed!"
        logmsg ""
        logmsg "The test program was:"
        logmsg "---------------------"
	printf "%s\n" "$source_code" >> $logfile
        logmsg "---------------------"
        logmsg "Compiler: ${cxx}"
        logmsg "Compiler flags: ${cxxflags}"
        logmsg "Compilation command:"
        echo "   ${cxx} -o ${_exe} ${cxxflags} ${_src} > ${_log} 2>&1" >> $logfile
        logmsg "Compiler error message:"
        cat ${_log} >> $logfile
	logmsg "==================================="
	return 1
    }

    logmsg "   Status: compilation successful."

    # run the executable
    logmsg "Running executable: $_exe"
    cpp_output=$(${_exe} 2>&1)
    cpp_exit="$?"
    logmsg "The executable returned exit code: $cpp_exit"
    if [ -z "$cpp_output" ]; then
	logmsg "The executable produced no output."
    else
	logmsg "The executable produced output:"
	printf "%s\n" "${cpp_output}" >> $logfile
    fi

    logmsg "==================================="

    return 0
}

#_____________________________________________________________________
use_algorithm() {
    # This function tests if a certain algorithm [$1] is used.

    # Assert that we got enough arguments
    if test $# -ne 1 ; then
        echo "use_algorithm: Exactly one argument required"
        return 1
    fi

    # check that the argument is an algorithm
    alg=`echo "$available_algorithms" | grep $1`
    if [ -z "$alg" ]; then
	message "Error: $1 is not an available algorithm"
	exit 1
    fi

    # check if the argument is in the list of used algorithms
    alg=`echo "$ALGORITHMS" | grep $1`
    if [ -z "$alg" ]; then
	return 1;
    else
	return 0;
    fi
}

#_____________________________________________________________________
exists_in_path () {
    # This function will try to locate an executable [$1] in $PATH.
    #
    # The result of the search is stored in cmd, which should be
    # immediately copied, since the variables value will be
    # overwritten at next invocation of this function.

    # Assert that we got enough arguments
    if test $# -ne 1 ; then
        echo "exists_in_path: Exactly one argument required"
        return 1
    fi

    cmd=$(command -v -- "$1")
    case "$cmd" in
	/*) return 0 ;;
	alias\ *) return 1 ;; # alias
	*) return 1 ;; # built-in or function
    esac
}

#_____________________________________________________________________
is_empty_dir() {
    if test $# -ne 1 ; then
        echo "is_empty_dir: Exactly one argument required"
        return 1
    fi

    find $1 -maxdepth 0 -empty | read v
}

#_____________________________________________________________________
check_install() {
    if test -z "${INSTALL_DIR}"; then
        return 0
    fi

    checking_msg "availability of install"

    if exists_in_path "install"; then
        result "ok"
    else
        result "no ok"
        message "Error: The installation program \`install' needs to be installed."
        message "   \`install' is part of the GNU coreutils and can be downloaded from"
        message "   https://www.gnu.org/software/coreutils/"
        exit 1
    fi
}

#_____________________________________________________________________
check_install_dir() {
    if test -z "${INSTALL_DIR}"; then
        return 0
    fi

    checking_msg "source code installation directory"

    # check if $INSTALL_DIR exists
    if test -d "${INSTALL_DIR}"; then
        # check if $INSTALL_DIR is empty
        if is_empty_dir "${INSTALL_DIR}"; then
            result "ok"
        else
            result "ok"
            message "Warning: Source code installation directory is non-empty."
            message "   Existing files might be overwritten!"
        fi
    else
        result "ok"
        logmsg "Source code installation directory does not exist."
    fi

    logmsg "Source code installation directory: ${INSTALL_DIR}"
}

#_____________________________________________________________________
check_algorithms() {
    if test -z "${ALGORITHMS}"; then
        logmsg "No RGE solver algorithms specified"
        return 0
    fi

    checking_msg "RGE solver algorithms"
    algs=`echo $ALGORITHMS | tr ',' ' '`
    ALGORITHMS=""
    for a in ${algs}; do
        case "$a" in
            all)
                ALGORITHMS="$available_algorithms"; break ;;
            two_scale|lattice)
                ALGORITHMS="$ALGORITHMS $a"
                continue ;;
            *)
                message "Error: unknown algorithm: $a";
                message "Available algorithms: $available_algorithms";
                exit 1 ;;
        esac
    done

    # strip whitespace
    ALGORITHMS="`echo ${ALGORITHMS} | sed -e 's/^ *//' -e 's/ *$//'`"

    result "ok (${ALGORITHMS})"
    logmsg "   Algorithms: ${ALGORITHMS}"
}

#_____________________________________________________________________
check_models() {
    if test -z "${MODELS}"; then
        logmsg "No models specified"
        return 0
    fi

    checking_msg "models"
    models=`echo $MODELS | tr ',' ' '`
    MODELS=""
    for a in ${models}; do
        case "$a" in
            all)
                MODELS=`find $BASEDIR/models/* -maxdepth 0 -type d -print0 | tr '\0' ' ' | sed -e 's|^\./||' -e 's| \./| |g' -e 's| *$||g'`
                break ;;
            *)
                if test -d "$BASEDIR/models/$a" ; then
                    MODELS="$MODELS models/$a"
                    continue
                else
                    result "not ok"
                    message "Error: model directory \"$BASEDIR/models/$a\" does not exist!"
                    message "   Please create the directory and put a model file in it."
                    message "   You can use \`./createmodel --name=<model>' to create one."
                    exit 1
                fi ;;
        esac
    done

    # test model dependencies (SoftsusyNMSSM depends on SoftsusyMSSM)
    if contains "${MODELS}" "models/SoftsusyNMSSM"; then
        if contains_not "${MODELS}" "models/SoftsusyMSSM"; then
            result "not ok"
            message "Error: model SoftsusyNMSSM requires model SoftsusyMSSM !"
            message "   Please select the model SoftsusyMSSM as well:"
            message "   --with-models=SoftsusyMSSM,SoftsusyNMSSM"
            exit 1
        fi
    fi

    # check for Makefile module, start script and FlexibleSUSY model
    # file
    for m in ${MODELS}; do
        if ! test -r ${m}/module.mk; then
            result "not ok"
            message "Error: No Makefile module found in ${m}"
            message "   Please create ${m}/module.mk !"
            exit 1
        fi
        if ! test -r ${m}/start.m; then
            logmsg ""
            logmsg "Note: No start script not found in ${m}"
        fi
        if ! test -r ${m}/FlexibleSUSY.m; then
            logmsg ""
            logmsg "Note: No FlexibleSUSY model file found in ${m}"
        fi
    done

    local model_names="`echo ${MODELS} | sed -e 's|models/||g' -e 's/^ *//' -e 's/ *$//'`"

    result "ok (${model_names})"
    logmsg "   Models: ${MODELS}"
}

#_____________________________________________________________________
check_platform() {
    # checks which platform we have

    logmsg ""
    logmsg "# Platform information"
    logmsg ""
    logmsg "hostname = `(hostname || uname -n) 2>/dev/null | sed 1q`"
    logmsg "uname -m = `(uname -m) 2>/dev/null || echo unknown`"
    logmsg "uname -r = `(uname -r) 2>/dev/null || echo unknown`"
    logmsg "uname -s = `(uname -s) 2>/dev/null || echo unknown`"
    logmsg "uname -v = `(uname -v) 2>/dev/null || echo unknown`"
    logmsg "Machine word size: ${machine_word_size}"
    logmsg ""

    local _paths="`echo $PATH | tr ':' ' '`"
    for p in ${_paths}; do
        logmsg "PATH: ${p}"
    done
    logmsg ""

    operating_system="`(uname -s) 2>/dev/null || echo unknown`"
    kernel_version="`(uname -r) 2>/dev/null || echo unknown`"
}

#_____________________________________________________________________
check_multiarch() {
    local linuxdist=""
    debmultiarch=""

    exists_in_path "lsb_release"
    if [ -n "$cmd" ] ; then
        if lsb_release -d | grep -i 'ubuntu\|debian\|mint' > /dev/null 2>&1; then
            linuxdist="multiarch"
        fi
    fi

    if test "x$linuxdist" = "xmultiarch"; then
        if `which dpkg-architecture > /dev/null 2>&1` ; then
            if `dpkg-architecture -qDEB_HOST_MULTIARCH > /dev/null 2>&1` ; then
                checking_msg "dpkg-architecture"
                debmultiarch=`dpkg-architecture -qDEB_HOST_MULTIARCH 2> /dev/null`
                result "$debmultiarch"
            fi
        else
            result "`basename $0`: dpkg-architecture MUST be installed"
            exit 1
        fi
    fi
}

#_____________________________________________________________________
check_boost() {
    check_header "boost/version.hpp" "$boost_inc_dir" \
	"$default_inc_paths"
    if test "x$found_hdr" = "x" ; then
        message "Error: could not find boost/version.hpp in ${boost_inc_dir} ${default_inc_paths}"
        message "   Boost ${required_boost_version} or higher must be installed,"
        message "   see http://www.boost.org"
        exit 1
    else
        # assume that the compiler will look in the default paths
        if [ -n "$boost_inc_dir" ]; then
            BOOSTFLAGS="-I$boost_inc_dir"
        fi
    fi
}

#_____________________________________________________________________
check_boost_version() {
    checking_msg "boost version >= $required_boost_version"

    try_compile_run_cpp_program "#include <iostream>
#include <boost/version.hpp>
int main() {
   int boost_major = BOOST_VERSION / 100000;
   int boost_minor = BOOST_VERSION / 100 % 1000;
   int boost_patch = BOOST_VERSION % 100;
   std::cout << boost_major << '.' << boost_minor << '.' << boost_patch << '\n';
   return 0;
}" "$CXX" "${BOOSTFLAGS}" && [ $cpp_exit = 0 ] || {
        result "unknown"
        message "Warning: could not determine boost version because"
        message "   compilation or execution of the boost test program failed."
	return 1
    }

    local boost_version="$cpp_output"

    version_at_least "$boost_version" "$required_boost_version" || {
        result "not ok (version ${boost_version})"
        message "Error: the installed boost version is too old."
        message "   Please install version ${required_boost_version} or higher."
        message "   You can use --with-boost-incdir= and --with-boost-libdir="
        message "   to use a boost installation from a non-default location."
        exit 1
    }
    result "ok (version ${boost_version})"
    logmsg "   Required boost version: ${required_boost_version}"
    logmsg "   Boost version found: ${boost_version}"
}

#_____________________________________________________________________
check_boost_test_libs() {
    check_library "libboost_unit_test_framework" "$boost_lib_dir" \
	"$default_lib_paths"
    if test "x$found_lib" = "x" ; then
        message "Warning: libboost_unit_test_framework must be installed"
        message "  to compile and run the tests, see http://www.boost.org"
    else
        local BOOSTTESTLIBS_=-lboost_unit_test_framework
        if [ -z "$boost_lib_dir" ]; then
            # assume that the linker will look in the default paths
            BOOSTTESTLIBS="$BOOSTTESTLIBS_"
        else
            BOOSTTESTLIBS="-L$boost_lib_dir $BOOSTTESTLIBS_"
        fi
    fi
}

#_____________________________________________________________________
check_boost_test_incl() {
    check_header "boost/test/unit_test.hpp" "$boost_inc_dir" \
	"$default_inc_paths"
    if test "x$found_hdr" = "x" ; then
        message "Warning: boost/test/unit_test.hpp must be installed"
        message "  to compile and run the tests, see http://www.boost.org"
    fi
}

#_____________________________________________________________________
check_boost_thread_libs() {
    check_library "libboost_thread libboost_thread-mt" \
	"$boost_lib_dir" "$default_lib_paths"
    if [ -z "$found_lib" ]; then
        message "Error: libboost_thread or libboost_thread-mt must be installed"
        message "  to enable multithreading in the lattice method, see http://www.boost.org"
        message "  You can disable the lattice method with the --with-algorithms= flag."
        exit 1
    fi
    local BOOSTTHREADLIBS_=-l$(echo "$found_lib" | sed 's/^lib\(.*\)\..*$/\1/')

    check_library "libboost_system libboost_system-mt" \
	"$boost_lib_dir" "$default_lib_paths"
    if [ -z "$found_lib" ]; then
        message "Error: libboost_system or libboost_system-mt must be installed"
        message "  to enable multithreading in the lattice method, see http://www.boost.org"
        message "  You can disable the lattice method with the --with-algorithms= flag."
        exit 1
    fi
    BOOSTTHREADLIBS_="$BOOSTTHREADLIBS_ "-l$(
	echo "$found_lib" | sed 's/^lib\(.*\)\..*$/\1/')

    if [ -z "$boost_lib_dir" ]; then
        # assume that the linker will look in the default paths
        BOOSTTHREADLIBS="$BOOSTTHREADLIBS_"
    else
        BOOSTTHREADLIBS="-L$boost_lib_dir $BOOSTTHREADLIBS_"
    fi
}

#_____________________________________________________________________
check_boost_thread_incl() {
    check_header "boost/thread/thread.hpp" "$boost_inc_dir" \
	"$default_inc_paths"
    if test "x$found_hdr" = "x" ; then
        message "Error: boost/thread/thread.hpp must be installed"
        message "  to enable multithreading in the lattice method, see http://www.boost.org"
        message "  You can disable the lattice method with the --with-algorithms= flag."
        exit 1
    else
        # assume that the compiler will look in the default paths
        if [ -n "$boost_inc_dir" ]; then
            BOOSTFLAGS="-I$boost_inc_dir"
        fi
    fi
}

#_____________________________________________________________________
check_std_threads() {
    # check for C++ std::thread and std::mutex
    if test "x${enable_threads}" = "xyes" ; then
        checking_msg "std::thread"
        if try_compile_cpp_program "#include <thread>
#include <mutex>" "std::mutex mtx; std::thread thr;";
        then
            result "ok"
        else
            result "not available"
            message "Error: C++ std::thread and std::mutex is not available."
            message "   Either reconfigure with \`--disable-threads' or use a"
            message "   C++ compiler which supports C++ std::thread and std::mutex."
            enable_threads="no"
            exit 1
        fi
    fi
}

#_____________________________________________________________________
check_thread_libs() {
    check_library "libpthread" "" "$default_lib_paths"
    if [ -z "$found_lib" ]; then
        message "Error: libpthread must be installed to enable multithreading!"
        exit 1
    fi
    THREADLIBS=-l$(echo "$found_lib" | sed 's/^lib\(.*\)\..*$/\1/')
}

#_____________________________________________________________________
check_cxx_compiler_type() {
    checking_msg "type of C++ compiler ${CXX}"

    get_cxx_compiler_type "$CXX" cxx_compiler_type || return 1

    case "$cxx_compiler_type" in
    gnu)   result "GNU"
	   required_cxx_compiler_version="$required_gpp_compiler_version"
	   std_cxx11_compiler_version="$std_cxx11_gpp_version" ;;
    clang) result "Clang"
	   required_cxx_compiler_version="$required_clang_compiler_version"
	   std_cxx11_compiler_version="$std_cxx11_clang_version" ;;
    intel) result "Intel"
	   required_cxx_compiler_version="$required_icpc_compiler_version"
	   std_cxx11_compiler_version="$std_cxx11_icpc_version" ;;
    *)     result "unknown" ;;
    esac

    logmsg "C++ compiler type: ${cxx_compiler_type}"
}

#_____________________________________________________________________
check_cxx_compiler_version() {
    checking_msg "$CXX compiler version >= $required_cxx_compiler_version"

    case "$cxx_compiler_type" in
    gnu)   get_gpp_version   "$CXX" cxx_compiler_version || return 1 ;;
    clang) get_clang_version "$CXX" cxx_compiler_version || return 1 ;;
    intel) get_icpc_version  "$CXX" cxx_compiler_version || return 1 ;;
    *)     message "Warning: could not check C++ compiler version because"
           message "   its type is unknown."
	   return 1 ;;
    esac

    version_at_least \
	"$cxx_compiler_version" "$required_cxx_compiler_version" || {
        result "not ok (version $cxx_compiler_version)"
        message "Error: the installed $CXX version is too old."
        message "   Please install version $required_cxx_compiler_version or higher."
        exit 1
    }
    result "ok (version $cxx_compiler_version)"
    logmsg "   Required $CXX version: $required_cxx_compiler_version"
    logmsg "   $CXX version found: $cxx_compiler_version"
}

#_____________________________________________________________________
check_cxx_dep_gen_type() {
    checking_msg "type of C++ file dependency generator ${CXX_DEP_GEN}"

    get_cxx_compiler_type "$CXX_DEP_GEN" cxx_dep_gen_type || return 1

    case "$cxx_dep_gen_type" in
    gnu)   result "GNU"
	   std_cxx11_dep_gen_version="$std_cxx11_gpp_version" ;;
    clang) result "Clang"
	   std_cxx11_dep_gen_version="$std_cxx11_clang_version" ;;
    intel) result "Intel"
	   std_cxx11_dep_gen_version="$std_cxx11_icpc_version" ;;
    *)     result "unknown"
    esac

    logmsg "C++ dependency generator type: ${cxx_dep_gen_type}"
}

#_____________________________________________________________________
check_cxx_dep_gen_version() {
    checking_msg "$CXX_DEP_GEN dependency generator version"

    case "$cxx_dep_gen_type" in
    gnu)   get_gpp_version   "$CXX_DEP_GEN" cxx_dep_gen_version || return 1 ;;
    clang) get_clang_version "$CXX_DEP_GEN" cxx_dep_gen_version || return 1 ;;
    intel) get_icpc_version  "$CXX_DEP_GEN" cxx_dep_gen_version || return 1 ;;
    *)     result "unknown"
	   message "Warning: could not check C++ dependency generator version because"
           message "   its type is unknown."
	   return 1 ;;
    esac

    result "$cxx_dep_gen_version"
    logmsg "   $CXX_DEP_GEN dependency generator version found: $cxx_dep_gen_version"
}

#_____________________________________________________________________
get_cxx_compiler_type() {
    if test $# -ne 2; then
        message "get_cxx_compiler_type(): too few arguments"
        exit 1
    fi

    local compiler="$1"
    local ret_var="$2"

    local output
    output=$($compiler -dM -E -x c++ /dev/null) || {
        message "Warning: could not determine compiler type of $compiler because"
        message "   execution of $compiler failed."
	return 1
    }

    local compiler_type
    if   printf "%s" "$output" |
         grep '#define[[:space:]]*\(__llvm__\|__clang__\)' > /dev/null; then
	compiler_type=clang
    elif printf "%s" "$output" |
	 grep '#define[[:space:]]*__INTEL_COMPILER' > /dev/null; then
	compiler_type=intel
    elif printf "%s" "$output" |
	 grep '#define[[:space:]]*__GNUC__' > /dev/null; then
	compiler_type=gnu
    else
	compiler_type=unknown
    fi

    eval "$ret_var=\"$compiler_type\""
}

#_____________________________________________________________________
get_gpp_version() {
    if test $# -ne 2; then
        message "get_gpp_version(): too few arguments"
        exit 1
    fi

    local compiler="$1"
    local ret_var="$2"

    local output
    output=$($compiler -dM -E -x c++ /dev/null) || {
        message "Warning: could not determine $compiler version because"
        message "   execution of $compiler failed."
	return 1
    }
    local major=$(printf "%s" "$output" |
	sed 's/^.*__GNUC__[[:space:]]*\([[:digit:]]*\).*$/\1/p;d')
    local minor=$(printf "%s" "$output" |
	sed 's/^.*__GNUC_MINOR__[[:space:]]*\([[:digit:]]*\).*$/\1/p;d')
    local patch=$(printf "%s" "$output" |
	sed 's/^.*__GNUC_PATCHLEVEL__[[:space:]]*\([[:digit:]]*\).*$/\1/p;d')

    eval "$ret_var=\"$major.$minor.$patch\""
}

#_____________________________________________________________________
get_icpc_version() {
    if test $# -ne 2; then
        message "get_icpc_version(): too few arguments"
        exit 1
    fi

    local compiler="$1"
    local ret_var="$2"

    local output
    output=$($compiler -dM -E -x c++ /dev/null) || {
        message "Warning: could not determine $compiler version because"
        message "   execution of $compiler failed."
	return 1
    }
    local version=$(printf "%s" "$output" |
	sed 's/^.*__INTEL_COMPILER[[:space:]]*\([[:digit:]]*\)\([[:digit:]]\)\([[:digit:]]\).*$/\1.\2.\3/p;d')

    eval "$ret_var=\"$version\""
}

#_____________________________________________________________________
get_clang_version() {
    if test $# -ne 2; then
        message "get_clang_version(): too few arguments"
        exit 1
    fi

    local compiler="$1"
    local ret_var="$2"

    local output
    output=$($compiler -dM -E -x c++ /dev/null) || {
        message "Warning: could not determine $compiler version because"
        message "   execution of $compiler failed."
	return 1
    }
    local major=$(printf "%s" "$output" |
	sed 's/^.*__clang_major__[[:space:]]*\([[:digit:]]*\).*$/\1/p;d')
    local minor=$(printf "%s" "$output" |
	sed 's/^.*__clang_minor__[[:space:]]*\([[:digit:]]*\).*$/\1/p;d')
    local patch=$(printf "%s" "$output" |
	sed 's/^.*__clang_patchlevel__[[:space:]]*\([[:digit:]]*\).*$/\1/p;d')

    eval "$ret_var=\"$major.$minor.$patch\""
}

#_____________________________________________________________________
check_cxx() {
    checking_msg "C++ compiler $CXX"
    exists_in_path "$CXX"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: A C++ compiler must be installed to compile the models!"
        message "   Use --with-cxx= to specify the C++ compiler to be used."
        exit 1
    else
        result "found $cmd"
    fi
}

#_____________________________________________________________________
check_cxxflags() {
    case "$CXXFLAGS" in
    *-std=c++11*)
	version_at_least "$cxx_compiler_version" \
			 "$std_cxx11_compiler_version" || {
	    message "Replacing \`-std=c++11' by \`-std=c++0x' since $CXX is older than $std_cxx11_compiler_version"
	    CXXFLAGS=$(
		printf "%s" "$CXXFLAGS" | sed 's/-std=c++11/-std=c++0x/')
	}
    esac

    if test "x$enable_compiler_warnings" = "xyes" ; then
        if test "x${cxx_compiler_type}" = "xgnu"; then
            CXXFLAGS="${CXXFLAGS} -Wall -pedantic -Wextra\
 -Wcast-align -Woverloaded-virtual -Wnon-virtual-dtor\
 -Wno-unused-local-typedefs"
        elif test "x${cxx_compiler_type}" = "xintel"; then
            CXXFLAGS="${CXXFLAGS} -w3 -Wnon-virtual-dtor"
        fi
    fi

    if test "x$enable_static_libs" = "xno" ; then
        # check if -fPIC is in CXXFLAGS
        case "${CXX}" in
            g++*|clang++*|icpc*)
                if contains_not "${CXXFLAGS}" "-fPIC" ; then
                    message "   Warning: could not find -fPIC in CXXFLAGS, appending it"
                    CXXFLAGS="${CXXFLAGS} -fPIC"
                fi ;;
        esac
    fi
}

#_____________________________________________________________________
check_cxx_dep_gen() {
    checking_msg "C++ file dependency generator $CXX_DEP_GEN"
    exists_in_path "$CXX_DEP_GEN"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: A C++ file dependency generator must be installed!"
        message "   Use --with-cxx-dep-gen= to specify the dependency generator"
        message "   that should be used."
        exit 1
    else
        result "found $cmd"
    fi
}

#_____________________________________________________________________
check_cxxflags_dep_gen() {
    if version_at_least "$cxx_dep_gen_version" \
			"$std_cxx11_dep_gen_version"; then
        CXXFLAGS_DEP_GEN="-std=c++11"
    else
        CXXFLAGS_DEP_GEN="-std=c++0x"
    fi
}

#_____________________________________________________________________
check_eigen_incl() {
    eigen_inc_paths="$default_inc_paths /usr/include/eigen3 \
                     /usr/local/include/eigen3"
    check_header "Eigen/Core" "$eigen_inc_dir" "$eigen_inc_paths"
    if test "x$found_hdr" = "x" ; then
        message "Error: Eigen 3 must be installed, see http://eigen.tuxfamily.org"
        message "   You can use --with-eigen-incdir= to use an eigen installation"
        message "   from a non-default location."
        exit 1
    else
        EIGENFLAGS="-I$found_dir"
    fi
}

#_____________________________________________________________________
check_gsl_config() {
    checking_msg "GSL configuration $gsl_config"
    exists_in_path "$gsl_config"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: Gnu Scientific Library (GSL) needs to be installed!"
        message "  Either add the path to the \`gsl-config' program to \$PATH or"
        message "  use $0 --with-gsl-config=<path to gsl-config>"
        exit 1
    else
        result "found $cmd"
        GSLFLAGS=`$cmd --cflags`
        GSLLIBS=`$cmd --libs`
    fi
}

#_____________________________________________________________________
check_fc() {
    checking_msg "Fortran compiler $FC"
    exists_in_path "$FC"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: A Fortran compiler must be installed to compile the"
        message "   two-loop MSSM Higgs contributions!"
        message "   Use --with-fc= to specify the Fortran compiler to be used."
        exit 1
    else
        result "found $cmd"
    fi
}

#_____________________________________________________________________
check_fflags() {
    case "${FC}" in
        gfortran*)
            if contains_not "${FFLAGS}" "-frecursive" ; then
                logmsg "Note: Adding -frecursive to FFLAGS for thread safety."
                FFLAGS="${FFLAGS} -frecursive"
            fi
            ;;
        ifort*)
            if contains_not "${FFLAGS}" "-recursive" ; then
                logmsg "Note: Adding -recursive to FFLAGS for thread safety."
                FFLAGS="${FFLAGS} -recursive"
            fi
            ;;
    esac

    if test "x$enable_static_libs" = "xno" ; then
        # check if -fPIC is in FFLAGS
        case "${FC}" in
            gfortran*|ifort*)
                if contains_not "${FFLAGS}" "-fPIC" ; then
                    message "   Warning: could not find -fPIC in FFLAGS, appending it"
                    FFLAGS="${FFLAGS} -fPIC"
                fi ;;
        esac
    fi
}

#_____________________________________________________________________
check_fortran_libs() {
    case "$FC" in
        gfortran)
            gfortran_lib_search_paths=`gfortran -print-search-dirs | sed -n -e '/libraries:/s/libraries: *=//p' | tr ':' ' '`
            check_library "libgfortran" "$gfortran_lib_search_paths" "$default_lib_paths"
            if test "x$found_lib" = "x" ; then
                message "Error: libgfortran not found in $gfortran_lib_search_paths $default_lib_paths"
                exit 1
            else
                FLIBS="-L$found_dir -lgfortran -lm"
            fi ;;
        g77|f77)
            FLIBS="-lg2c -lm" ;;
        ifort)
            FLIBS="-lifcore -limf -ldl -lintlc -lsvml" ;;
    esac
}

#_____________________________________________________________________
check_fortran_dep_gen() {
    checking_msg "Fortran file dependency generator $FOR_DEP_GEN"
    exists_in_path "$FOR_DEP_GEN"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: A Fortran file dependency generator must be installed!"
        message "   Use --with-fortran-dep-gen= to specify the dependency generator"
        message "   that should be used."
        exit 1
    else
        result "found $cmd"
    fi
}

#_____________________________________________________________________
check_lapack_libs_using_options() {
    check_library "liblapack" "$lapack_lib_dir" \
	"$default_lib_paths"
    if test "x$found_lib" = "x" ; then
        message "Error: liblapack must be installed"
        message "  to run the lattice algorithm, see http://www.netlib.org/lapack"
        message "  You can disable the lattice algorithm with the"
        message "  --with-algorithms= flag"
        exit 1
    else
        local LAPACKLIBS_=-llapack
        if [ -z "$lapack_lib_dir" ]; then
            # assume that the linker will look in the default paths
            LAPACKLIBS="$LAPACKLIBS_"
        else
            LAPACKLIBS="-L$lapack_lib_dir $LAPACKLIBS_"
        fi
	check_symbol dgbsv_ "$found_lib" "$found_dir"
    fi
}

#_____________________________________________________________________
check_looptools_libs() {
    check_library "libooptools" "$looptools_lib_dir" \
	"$default_lib_paths"
    if test "x$found_lib" = "x" ; then
        message "Error: libooptools must be installed if you want"
        message "   to use LoopTools, see http://www.feynarts.de/looptools/"
        message "   You can use the --with-looptools-libdir= option to specify the"
        message "   location of the libooptools library."
        exit 1
    else
        local LOOPTOOLSLIBS_="-looptools"
        if [ -z "$looptools_lib_dir" ]; then
            # assume that the linker will look in the default paths
            LOOPTOOLSLIBS="$LOOPTOOLSLIBS_"
        else
            LOOPTOOLSLIBS="-L$looptools_lib_dir $LOOPTOOLSLIBS_"
        fi
    fi
}

#_____________________________________________________________________
check_looptools_incl() {
    check_header "clooptools.h" "$looptools_inc_dir" \
	"$default_inc_paths"
    if test "x$found_hdr" = "x" ; then
        message "Error: clooptools.h must be installed if you want"
        message "   to use LoopTools, see http://www.feynarts.de/looptools/"
        message "   You can use the --with-looptools-incdir= option to specify the"
        message "   location of the clooptools.h header."
        exit 1
    else
        # assume that the compiler will look in the default paths
        if [ -n "$looptools_inc_dir" ]; then
            LOOPTOOLSFLAGS="-I$looptools_inc_dir"
        fi
    fi
}

#_____________________________________________________________________
find_symbol_using_pkgconfig() {
    local symbol
    local pkg
    local ldpaths
    local libnames
    pkg="$1"
    linker_flags=""
    type pkg-config > /dev/null 2>&1 || {
	logmsg "pkg-config not found"
	return 1
    }
    pkg-config --exists "$pkg" || {
	logmsg "pkg-config does not manage $pkg"
	return 1
    }
    ldpaths=$(pkg-config --libs-only-L "$pkg")
    libnames=$(pkg-config --libs-only-l "$pkg")
    shift
    for symbol; do
	for dopt in $default_lib_paths $ldpaths; do
	    for lopt in $libnames; do
		if check_symbol "$symbol" "$lopt" "$dopt"; then
		    logmsg "found $symbol in $dopt $lopt"
		    linker_flags=$(pkg-config --libs "$pkg")
		    continue 3
		fi
	    done
	done
	return 1
    done
    return 0
}

#_____________________________________________________________________
check_lapack_libs() {
    if find_symbol_using_pkgconfig lapack dgbsv_; then
	LAPACKLIBS="$linker_flags"
    else
	check_lapack_libs_using_options
    fi
}

#_____________________________________________________________________
check_makelib() {
    checking_msg "build library command $MAKELIB"
    # strip arguments from the actual command
    makelib_cmd=`echo $MAKELIB | awk '{ print $1; }'`

    # check if $makelib_cmd can create shared libraries
    if test "x$enable_static_libs" = "xno" ; then
        if test "x$makelib_cmd" = "xar" ; then
            message ""
            message "   Error: $makelib_cmd cannot be used to create shared libraries!"
            message "   Please use --with-make-lib-cmd=\"gcc -shared -o\" or something similar."
            exit 1
        fi
    fi

    exists_in_path "$makelib_cmd"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: A program which builds libraries must be installed!"
        message "   Use --with-make-lib-cmd= to specify the library creator program to be used."
        exit 1
    else
        result "found $cmd"
    fi
}

#_____________________________________________________________________
check_math_cmd() {
    checking_msg "Mathematica kernel $MATH"
    exists_in_path "$MATH"
    if [ -z "$cmd" ] ; then
        result "not found"
        message "Error: Mathematica needs to be installed to run the meta code!"
        message "   You can use the --with-math-cmd= option to specify the location of"
        message "   the math kernel."
        case "$operating_system" in
            Linux)  message "   It is usually installed in /usr/local/Wolfram/Mathematica/" ;;
            Darwin) message "   It is usually installed in /Applications/Mathematica.app/"  ;;
        esac
        exit 1
    else
        result "found $cmd"
    fi
}

#_____________________________________________________________________
check_mathematica_version() {
    local _math_version_check_progr="${BASEDIR}/check_math_version.m"
    rm -f ${mathconfig} ${_math_version_check_progr}
    cat <<EOF > ${_math_version_check_progr}
error = 0;
Put[\$VersionNumber, "${mathconfig}"];
If[\$VersionNumber < ${required_mathematica_version},
   error = 1;
  ];
Quit[error];
EOF

    checking_msg "Mathematica version >= ${required_mathematica_version}"
    if $MATH -run "Get[\"${_math_version_check_progr}\"]" > /dev/null 2>&1;
    then
        if test -r "${mathconfig}" ; then
            MATH_VERSION=`cat ${mathconfig}`
            result "ok (version ${MATH_VERSION})"
        else
            result "ok"
        fi
    else
        result "not ok"
        message "Error: Mathematica ${required_mathematica_version} or higher needs to be installed!"
        rm -f ${_math_version_check_progr}
        exit 1
    fi
    rm -f ${_math_version_check_progr}
}

#_____________________________________________________________________
check_random_number_generator() {
    # check for random number generator
    checking_msg "random number generator"
    if try_compile_cpp_program "#include <random>" "std::minstd_rand generator; std::uniform_real_distribution<double> distribution(0., 1.);";
    then
        result "ok"
        DEFINE_ENABLE_RANDOM="#define ENABLE_RANDOM 1"
        logmsg "Enabling random number generator: ${DEFINE_ENABLE_RANDOM}"
    else
        result "not found"
        DEFINE_ENABLE_RANDOM="#undef ENABLE_RANDOM"
        logmsg "Disabling random number generator: ${DEFINE_ENABLE_RANDOM}"
    fi
}

#_____________________________________________________________________
check_sarah() {
    checking_msg "SARAH installation"
    rm -f ${sarahconfig}
    $MATH <<EOF > /dev/null
Needs["SARAH\`"];
If[!ValueQ[SA\`Version], Quit[1]];
Export["${sarahconfig}", SA\`Version, "String"];
Quit[0];
EOF
    local _sarah_is_available="$?"
    if test "x${_sarah_is_available}" = "x0" ; then
        if test -r "${sarahconfig}" ; then
            SARAH_VERSION=`cat ${sarahconfig}`
            SARAH_MAJOR=`echo ${SARAH_VERSION} | awk -F . '{ print $1 }'`
            SARAH_MINOR=`echo ${SARAH_VERSION} | awk -F . '{ print $2 }'`
            SARAH_PATCH=`echo ${SARAH_VERSION} | awk -F . '{ print $3 }'`
            if test \
                \( "${SARAH_MAJOR}" -lt "${required_sarah_major}" \) -o \
                \( \( "${SARAH_MAJOR}" -eq "${required_sarah_major}" \) -a \
                   \( "${SARAH_MINOR}" -lt "${required_sarah_minor}" \) \) -o \
                \( \( "${SARAH_MAJOR}" -eq "${required_sarah_major}" \) -a \
                   \( "${SARAH_MINOR}" -eq "${required_sarah_minor}" \) -a \
                   \( "${SARAH_PATCH}" -lt "${required_sarah_patch}" \) \)
            then
                result "not ok"
                message "Error: SARAH version ${SARAH_VERSION} no longer supported!"
                message "   Please use version ${required_sarah_version} or higher."
                exit 1
            else
                result "ok (version ${SARAH_VERSION})"
            fi
        else
            result "not ok"
            message "Error: Cannot not check SARAH version."
            exit 1
        fi
    else
        result "not ok"
        message "Error: SARAH is not installed correctly."
        message "   Please make sure Needs[\"SARAH\`\"] works correctly."
        exit 1
    fi
}

#_____________________________________________________________________
enable_defines() {
    if test "x$enable_colors" = "xyes" ; then
        DEFINE_ENABLE_COLOR_PRINTOUT="#define ENABLE_COLOR_PRINTOUT 1"
        message "Enabling colored output"
        logmsg "   ${DEFINE_ENABLE_COLOR_PRINTOUT}"
    else
        DEFINE_ENABLE_COLOR_PRINTOUT="#undef ENABLE_COLOR"
        logmsg "Disabling colored output"
        logmsg "   ${DEFINE_ENABLE_COLOR_PRINTOUT}"
    fi

    if test "x$enable_debug" = "xyes" ; then
        DEFINE_ENABLE_DEBUG="#define ENABLE_DEBUG 1"
        CXXFLAGS="$CXXFLAGS -g"
        FFLAGS="$FFLAGS -g"
        message "Enabling debug mode"
        logmsg "   ${DEFINE_ENABLE_DEBUG}"
        logmsg "   CXXFLAGS = ${CXXFLAGS}"
        logmsg "   FFLAGS   = ${FFLAGS}"
    elif test "x$enable_debug" = "x" ; then
        DEFINE_ENABLE_DEBUG="#undef ENABLE_DEBUG"
        logmsg "Disabling debug mode"
        logmsg "   ${DEFINE_ENABLE_DEBUG}"
    elif test "x$enable_debug" = "xno" ; then
        DEFINE_ENABLE_DEBUG="#undef ENABLE_DEBUG"
        CPPFLAGS="$CPPFLAGS -DNDEBUG"
        message "Disabling debug mode and assertions"
        logmsg "   ${DEFINE_ENABLE_DEBUG}"
        logmsg "   CPPFLAGS = ${CPPFLAGS}"
    fi

    if test "$enable_fflite" = "yes" -a "$enable_looptools" = "yes"; then
	message "Error: do not \`--enable-fflite' and \`--enable-looptools' at the same time"
	exit 1
    fi

    if test "x$enable_fflite" = "xyes" ; then
        DEFINE_ENABLE_FFLITE="#define ENABLE_FFLITE 1"
        message "Enabling usage of fflite"
    else
        DEFINE_ENABLE_FFLITE="#undef ENABLE_FFLITE"
        logmsg "Disabling usage of fflite"
    fi
    logmsg "   ${DEFINE_ENABLE_FFLITE}"

    if test "x$enable_looptools" = "xyes" ; then
        DEFINE_ENABLE_LOOPTOOLS="#define ENABLE_LOOPTOOLS 1"
        message "Enabling usage of LoopTools"
	message "Warning: LoopTools is thread-unsafe since it accepts the renormalization scale"
	message "   via a global variable.  This might lead to a race condition if different"
	message "   RGE solvers run in multiple threads.  For such an application, consider the"
	message "   alternative \`--enable-fflite'."
        logmsg "   ${DEFINE_ENABLE_LOOPTOOLS}"
    else
        DEFINE_ENABLE_LOOPTOOLS="#undef ENABLE_LOOPTOOLS"
        logmsg "Disabling usage of LoopTools"
        logmsg "   ${DEFINE_ENABLE_LOOPTOOLS}"
    fi

    if test "x$enable_silent" = "xyes" ; then
        DEFINE_ENABLE_SILENT="#define ENABLE_SILENT 1"
        CPPFLAGS="$CPPFLAGS"
        message "Enabling silent mode"
        logmsg "   ${DEFINE_ENABLE_SILENT}"
    else
        DEFINE_ENABLE_SILENT="#undef ENABLE_SILENT"
        logmsg "Disabling silent mode"
        logmsg "   ${DEFINE_ENABLE_SILENT}"
    fi

    if test "x$enable_static_libs" = "xno" ; then
        # check the library extension
        if test "x$LIBEXT" = "x.a" ; then
            message "  Warning: library extension $LIBEXT is reserved for static libraries."
            message "    Please consider using .so as library extension, or similar, e.g."
            message "    --with-lib-ext=\".so\""
        fi
    fi

    if test "x$enable_verbose" = "xyes" ; then
        if test "x$enable_silent" = "xyes" ; then
            message "Warning: ignoring --enable-verbose because silent mode is enabled!"
            DEFINE_ENABLE_VERBOSE="#undef ENABLE_VERBOSE"
            logmsg "Disabling verbose mode"
            logmsg "   ${DEFINE_ENABLE_VERBOSE}"
        else
            DEFINE_ENABLE_VERBOSE="#define ENABLE_VERBOSE 1"
            message "Enabling verbose mode"
            logmsg "   ${DEFINE_ENABLE_VERBOSE}"
        fi
    fi

    if test "x${enable_threads}" = "xyes" ; then
        DEFINE_ENABLE_THREADS="#define ENABLE_THREADS 1"
        logmsg "Enabling multi-threading"
        logmsg "   ${DEFINE_ENABLE_THREADS}"
    else
        DEFINE_ENABLE_THREADS="#undef ENABLE_THREADS"
        message "Disabling multi-threading"
        logmsg "   ${DEFINE_ENABLE_THREADS}"
    fi
}

#_____________________________________________________________________
help() {
cat <<EOF
Usage: ./`basename $0` [options]
Options:

  --help,-h         Print this help message
  --version,-v      Print version information

enable/disable options, prefix with either --enable- or --disable-

  colors            Colored output (default: $enable_colors)
  compile           Compile the source code (default: $enable_compile)
  compiler-warnings Enable compiler warnings (default: $enable_compiler_warnings)
  debug             Debug messages and assertions (no default)
  fflite            Use fflite to compute the loop functions (default: $enable_fflite)
  looptools         Use LoopTools to compute the loop functions (default: $enable_looptools)
EOF
# BEGIN: NOT EXPORTED ##########################################
cat <<EOF
  meta              Create model classes (default: $enable_meta)
EOF
# END:   NOT EXPORTED ##########################################
cat <<EOF
  silent            Suppress all command line output (default: $enable_silent)
  static-libs       Create static libraries (default: $enable_static_libs)
  threads           Enable multi-threading (default: $enable_threads)
  verbose           Verbose messages (default: $enable_verbose)

Package directories, compilation settings and model selection

  --with-algorithms=        Comma separated list of RG solver algorithms
                            (default: $ALGORITHMS)
                            possible values: all $available_algorithms
  --with-boost-libdir=      Path to search for BOOST libraries
  --with-boost-incdir=      Path to search for BOOST headers
  --with-cxx=               C++ compiler (default: $CXX)
  --with-cxxflags=          C++ compiler flags (default: $CXXFLAGS)
  --with-cxx-dep-gen=       C++ file dependency generator (default: $CXX_DEP_GEN)
  --with-eigen-incdir=      Path to search for Eigen headers
  --with-fc=                Fortran compiler (default: $FC)
  --with-fflags=            Fortran compiler flags (default: $FFLAGS)
  --with-fortran-dep-gen=   Fortran file dependency generator (default: $FOR_DEP_GEN)
  --with-gsl-config=        Path to gsl-config (default: $gsl_config)
  --with-install-dir=       Path to source code installation directory
  --with-lapack-libdir=     Path to search for LAPACK and BLAS libraries
  --with-lib-ext=           Library extension (default: $LIBEXT)
  --with-looptools-libdir=  Path to search for LoopTools libraries
  --with-looptools-incdir=  Path to search for LoopTools headers
  --with-make-lib-cmd       Command to make library (default: $MAKELIB)
EOF
# BEGIN: NOT EXPORTED ##########################################
cat <<EOF
  --with-math-cmd=          Mathematic kernel (default: $MATH)
EOF
# END:   NOT EXPORTED ##########################################
cat <<EOF
  --with-models=            Comma separated list of models to be build
                            (default: $MODELS)
                            possible values: all <model1>,<model2>,...
EOF
}

#_____________________________________________________________________
version() {
cat <<EOF
$PROGRAM_NAME $FLEXIBLESUSY_VERSION
$PROGRAM_NAME is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.  See http://www.gnu.org/licenses/
EOF
}

trap do_actions_at_exit 0
trap "exit 1" INT QUIT TERM

rm -f $logfile
write_configure_parameters "$*"

if test $# -gt 0 ; then
    while test ! "x$1" = "x" ; do
        case "$1" in
            -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
            *) optarg= ;;
        esac

        case $1 in
            --enable-*)
                f=`echo $1 | sed -e 's/--//' -e 's/-/_/g'`
                eval prev='$'`echo ${f}`
                if test "x${prev}" = "xyes"; then
                    echo "INFO: $1: already enabled by default."
                fi
                if test ! "x`echo ${deprecated_options} | grep ${f}`" = "x"; then
                    echo "WARNING: option $1 is deprecated and ignored"'!'
                fi
                eval ${f}=yes
                for c in $options ; do
                    if test "x$c" = "x$f" ; then
                        f=""
                    fi
                done
                for c in $deprecated_options ; do
                    if test "x$c" = "x$f" ; then
                        f=""
                    fi
                done
                if test "x$f" != "x" ; then
                    echo "Invalid option '$1'. Try $0 --help" ; exit 1 ;
                fi
                ;;
            --disable-*)
                f=`echo $1 | sed -e 's/--disable/enable/' -e 's/-/_/g'`
                eval prev='$'`echo ${f}`
                if test "x${prev}" = "xno"; then
                    echo "INFO: $1: already disabled by default."
                fi
                eval ${f}=no
                for c in $options ; do
                    if test "x$c" = "x$f" ; then
                        f=""
                    fi
                done
                if test "x$f" != "x" ; then
                    echo "Invalid option '$1'. Try $0 --help" ; exit 1 ;
                fi
                ;;
            --with-algorithms=*)     ALGORITHMS=$optarg ;;
            --with-boost-libdir=*)   boost_lib_dir=$optarg ;;
            --with-boost-incdir=*)   boost_inc_dir=$optarg ;;
            --with-cxx=*)            CXX=$optarg ;;
            --with-cxxflags=*)       CXXFLAGS=$optarg ;;
            --with-cxx-dep-gen=*)    CXX_DEP_GEN=$optarg ;;
            --with-eigen-incdir=*)   eigen_inc_dir=$optarg ;;
            --with-fc=*)             FC=$optarg ;;
            --with-fflags=*)         FFLAGS=$optarg ;;
            --with-fortran-dep-gen=*) FOR_DEP_GEN=$optarg ;;
            --with-gsl-config=*)     gsl_config=$optarg ;;
            --with-install-dir=*)    INSTALL_DIR=$optarg ;;
            --with-lapack-libdir=*)  lapack_lib_dir=$optarg ;;
            --with-lib-ext=*)        LIBEXT=$optarg ;;
            --with-looptools-libdir=*) looptools_lib_dir=$optarg ;;
            --with-looptools-incdir=*) looptools_inc_dir=$optarg ;;
            --with-make-lib-cmd=*)   MAKELIB=$optarg ;;
            --with-math-cmd=*)       MATH=$optarg ;;
            --with-models=*)         MODELS=$optarg ;;
            --help|-h)               help; exit 0 ;;
            --version|-v)            version; exit 0 ;;
            *)  echo "Invalid option '$1'. Try $0 --help" ; exit 1 ;;
        esac
        shift
    done
fi

log_package_information
guess_machine_word_size
check_platform
check_algorithms
check_install
check_install_dir

if test "x${enable_compile}" = "xyes"; then
    check_multiarch
    check_cxx
    check_cxx_compiler_type
    check_cxx_compiler_version
    check_cxxflags
    check_cxx_dep_gen
    check_cxx_dep_gen_type
    check_cxx_dep_gen_version
    check_cxxflags_dep_gen
    check_fc
    check_fflags
    check_fortran_dep_gen
    check_boost
    check_boost_version
    check_boost_test_incl
    check_boost_test_libs
    check_eigen_incl
    check_fortran_libs
    check_gsl_config
    check_lapack_libs
    if use_algorithm "lattice"; then
        check_boost_thread_incl
        check_boost_thread_libs
    fi
    if test "x$enable_looptools" = "xyes"; then
        check_looptools_incl
        check_looptools_libs
    fi
    check_makelib
    check_random_number_generator
    check_std_threads
    check_thread_libs
fi

if test "x${enable_meta}" = "xyes"; then
    check_math_cmd
    check_mathematica_version
    check_sarah
fi

check_models

enable_defines

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"    \
    -e "s|@ABSBASEDIR@|$ABSBASEDIR|"   \
    -e "s|@INSTALL_DIR@|$INSTALL_DIR|" \
    -e "s|@ALGORITHMS@|$ALGORITHMS|"   \
    -e "s|@BOOSTTESTLIBS@|$BOOSTTESTLIBS|"     \
    -e "s|@BOOSTTHREADLIBS@|$BOOSTTHREADLIBS|"     \
    -e "s|@BOOSTFLAGS@|$BOOSTFLAGS|"   \
    -e "s|@THREADLIBS@|$THREADLIBS|"   \
    -e "s|@CPPFLAGS@|$CPPFLAGS|"       \
    -e "s|@CXXFLAGS@|$CXXFLAGS|"       \
    -e "s|@CXXFLAGS_DEP_GEN@|$CXXFLAGS_DEP_GEN|"   \
    -e "s|@CXX@|$CXX|"                 \
    -e "s|@CXX_DEP_GEN@|$CXX_DEP_GEN|" \
    -e "s|@FC@|$FC|"                   \
    -e "s|@FFLAGS@|$FFLAGS|"           \
    -e "s|@FLIBS@|$FLIBS|"             \
    -e "s|@FOR_DEP_GEN@|$FOR_DEP_GEN|" \
    -e "s|@FSCONFIG@|$FSCONFIG|"       \
    -e "s|@EIGENFLAGS@|$EIGENFLAGS|"   \
    -e "s|@GSLLIBS@|$GSLLIBS|"         \
    -e "s|@GSLFLAGS@|$GSLFLAGS|"       \
    -e "s|@LAPACKLIBS@|$LAPACKLIBS|"   \
    -e "s|@SARAH_DEP_GEN@|$SARAH_DEP_GEN|"   \
    -e "s|@ENABLE_COMPILE@|$enable_compile|" \
    -e "s|@ENABLE_FFLITE@|$enable_fflite|" \
    -e "s|@ENABLE_LOOPTOOLS@|$enable_looptools|" \
    -e "s|@ENABLE_META@|$enable_meta|" \
    -e "s|@ENABLE_THREADS@|$enable_threads|"  \
    -e "s|@LOOPTOOLSLIBS@|$LOOPTOOLSLIBS|"    \
    -e "s|@LOOPTOOLSFLAGS@|$LOOPTOOLSFLAGS|"  \
    -e "s|@MODELS@|$MODELS|"           \
    -e "s|@MAKELIB@|$MAKELIB|"         \
    -e "s|@ENABLE_STATIC_LIBS@|$enable_static_libs|" \
    -e "s|@MATH@|$MATH|"               \
    -e "s|@LIBEXT@|$LIBEXT|"           \
    < $MAKEFILE_TMPL > $MAKEFILE

# BEGIN: NOT EXPORTED ##########################################

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"    \
    -e "s|@ABSBASEDIR@|$ABSBASEDIR|"   \
    -e "s|@BOOSTTESTLIBS@|$BOOSTTESTLIBS|"     \
    -e "s|@BOOSTTHREADLIBS@|$BOOSTTHREADLIBS|"     \
    -e "s|@BOOSTFLAGS@|$BOOSTFLAGS|"   \
    -e "s|@THREADLIBS@|$THREADLIBS|"   \
    -e "s|@CPPFLAGS@|$CPPFLAGS|"       \
    -e "s|@CXXFLAGS@|$CXXFLAGS|"       \
    -e "s|@CXXFLAGS_DEP_GEN@|$CXXFLAGS_DEP_GEN|"   \
    -e "s|@CXX@|$CXX|"                 \
    -e "s|@CXX_DEP_GEN@|$CXX_DEP_GEN|" \
    -e "s|@FC@|$FC|"                   \
    -e "s|@FFLAGS@|$FFLAGS|"           \
    -e "s|@FLIBS@|$FLIBS|"             \
    -e "s|@FOR_DEP_GEN@|$FOR_DEP_GEN|" \
    -e "s|@EIGENFLAGS@|$EIGENFLAGS|"   \
    -e "s|@FSCONFIG@|$FSCONFIG|"       \
    -e "s|@GSLLIBS@|$GSLLIBS|"         \
    -e "s|@GSLFLAGS@|$GSLFLAGS|"       \
    -e "s|@LAPACKLIBS@|$LAPACKLIBS|"   \
    -e "s|@ENABLE_FFLITE@|$enable_fflite|" \
    -e "s|@ENABLE_LOOPTOOLS@|$enable_looptools|" \
    -e "s|@ENABLE_THREADS@|$enable_threads|"  \
    -e "s|@LOOPTOOLSLIBS@|$LOOPTOOLSLIBS|"    \
    -e "s|@LOOPTOOLSFLAGS@|$LOOPTOOLSFLAGS|"  \
    -e "s|@MAKELIB@|$MAKELIB|"         \
    -e "s|@ENABLE_STATIC_LIBS@|$enable_static_libs|" \
    -e "s|@LIBEXT@|$LIBEXT|"           \
    < $STANDALONE_MAKEFILE_TMPL | tee $STANDALONE_MAKEFILES > /dev/null

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"    \
    -e "s|@ABSBASEDIR@|$ABSBASEDIR|"   \
    -e "s|@BOOSTTESTLIBS@|$BOOSTTESTLIBS|"     \
    -e "s|@BOOSTTHREADLIBS@|$BOOSTTHREADLIBS|"     \
    -e "s|@BOOSTFLAGS@|$BOOSTFLAGS|"   \
    -e "s|@THREADLIBS@|$THREADLIBS|"   \
    -e "s|@CPPFLAGS@|$CPPFLAGS|"       \
    -e "s|@CXXFLAGS@|$CXXFLAGS|"       \
    -e "s|@CXXFLAGS_DEP_GEN@|$CXXFLAGS_DEP_GEN|"   \
    -e "s|@CXX@|$CXX|"                 \
    -e "s|@CXX_DEP_GEN@|$CXX_DEP_GEN|" \
    -e "s|@FC@|$FC|"                   \
    -e "s|@EIGENFLAGS@|$EIGENFLAGS|"   \
    -e "s|@FFLAGS@|$FFLAGS|"           \
    -e "s|@FLIBS@|$FLIBS|"             \
    -e "s|@FOR_DEP_GEN@|$FOR_DEP_GEN|" \
    -e "s|@FSCONFIG@|$FSCONFIG|"       \
    -e "s|@GSLLIBS@|$GSLLIBS|"         \
    -e "s|@GSLFLAGS@|$GSLFLAGS|"       \
    -e "s|@LAPACKLIBS@|$LAPACKLIBS|"   \
    -e "s|@ENABLE_FFLITE@|$enable_fflite|" \
    -e "s|@ENABLE_LOOPTOOLS@|$enable_looptools|" \
    -e "s|@ENABLE_THREADS@|$enable_threads|"  \
    -e "s|@LOOPTOOLSLIBS@|$LOOPTOOLSLIBS|"    \
    -e "s|@LOOPTOOLSFLAGS@|$LOOPTOOLSFLAGS|"  \
    -e "s|@MAKELIB@|$MAKELIB|"         \
    -e "s|@ENABLE_STATIC_LIBS@|$enable_static_libs|" \
    -e "s|@LIBEXT@|$LIBEXT|"           \
    < $TOWER_MAKEFILE_TMPL | tee $TOWER_MAKEFILES > /dev/null

# END:   NOT EXPORTED ##########################################

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"    \
    -e "s|@CPPFLAGS@|$CPPFLAGS|"       \
    -e "s|@CXXFLAGS@|$CXXFLAGS|"       \
    -e "s|@CXX@|$CXX|"                 \
    -e "s|@FC@|$FC|"                   \
    -e "s|@FFLAGS@|$FFLAGS|"           \
    -e "s|@FLIBS@|$FLIBS|"             \
    -e "s|@MAKELIB@|$MAKELIB|"         \
    -e "s|@MATH@|$MATH|"               \
    -e "s|@MODELS@|$MODELS|"           \
    -e "s|@THREADLIBS@|$THREADLIBS|"   \
    < $FSCONFIG_TMPL > $FSCONFIG

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"                  \
    -e "s|@CXX@|$CXX|"                               \
    -e "s|@CXXFLAGS@|$CXXFLAGS|"                     \
    -e "s|@FC@|$FC|"                                 \
    -e "s|@FFLAGS@|$FFLAGS|"                         \
    -e "s|@FLIBS@|$FLIBS|"                           \
    -e "s|@MATH_VERSION@|$MATH_VERSION|"             \
    -e "s|@SARAH_VERSION@|$SARAH_VERSION|"           \
    -e "s|@SARAH_MAJOR@|$SARAH_MAJOR|"               \
    -e "s|@SARAH_MINOR@|$SARAH_MINOR|"               \
    -e "s|@SARAH_PATCH@|$SARAH_PATCH|"               \
    -e "s|@OPERATING_SYSTEM@|$operating_system|"     \
    -e "s|@KERNEL_VERSION@|$kernel_version|"         \
    -e "s|@DATE@|$DATE|"                             \
    -e "s|@DEFINE_ENABLE_COLOR_PRINTOUT@|$DEFINE_ENABLE_COLOR_PRINTOUT|" \
    -e "s|@DEFINE_ENABLE_DEBUG@|$DEFINE_ENABLE_DEBUG|"         \
    -e "s|@DEFINE_ENABLE_FFLITE@|$DEFINE_ENABLE_FFLITE|" \
    -e "s|@DEFINE_ENABLE_LOOPTOOLS@|$DEFINE_ENABLE_LOOPTOOLS|" \
    -e "s|@DEFINE_ENABLE_RANDOM@|$DEFINE_ENABLE_RANDOM|"       \
    -e "s|@DEFINE_ENABLE_SILENT@|$DEFINE_ENABLE_SILENT|"       \
    -e "s|@DEFINE_ENABLE_THREADS@|$DEFINE_ENABLE_THREADS|"     \
    -e "s|@DEFINE_ENABLE_VERBOSE@|$DEFINE_ENABLE_VERBOSE|"     \
    < $CONFIGHDR_TMPL > $CONFIGHDR

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"    \
    < $TEXVERSION_TMPL > $TEXVERSION

sed -e "s|@FLEXIBLESUSY_VERSION@|$FLEXIBLESUSY_VERSION|" \
    -e "s|@FLEXIBLESUSY_MAJOR@|$FLEXIBLESUSY_MAJOR|" \
    -e "s|@FLEXIBLESUSY_MINOR@|$FLEXIBLESUSY_MINOR|" \
    -e "s|@FLEXIBLESUSY_PATCH@|$FLEXIBLESUSY_PATCH|" \
    -e "s|@FLEXIBLESUSY_EXTRA@|$FLEXIBLESUSY_EXTRA|" \
    -e "s|@PKGNAME@|$PROGRAM_NAME|"    \
    < $DOC_MAINPAGE_TMPL > $DOC_MAINPAGE

sed -e "s|@MATH@|$MATH|" \
    < $SARAH_DEP_GEN_TMPL > $SARAH_DEP_GEN

echo "$FLEXIBLESUSY_VERSION" > ${CONFIGDIR}/version
echo "{${required_sarah_major}, ${required_sarah_minor}, ${required_sarah_patch}}" > ${CONFIGDIR}/required_sarah_version.m

chmod a+x $FSCONFIG
chmod a+x $SARAH_DEP_GEN
